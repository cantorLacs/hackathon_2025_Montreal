<!DOCTYPE html>
<html>
<head>
    <title>Test Propagación Orpheus</title>
    <script src="src/trajectory-simulator.js"></script>
</head>
<body>
    <h1>Test de Propagación - Orpheus</h1>
    <pre id="output"></pre>

    <script>
        const output = document.getElementById('output');
        
        // Crear simulador
        const simulator = new TrajectorySimulator();
        
        // Datos de Orpheus (exactamente como están en el código)
        const orpheusData = {
            "id": "2003361",
            "spkid": "2003361",
            "full_name": "3361 Orpheus (1982 HR)",
            "name": "Orpheus",
            "neo_reference_id": "2003361",
            "is_potentially_hazardous_asteroid": false,
            "absolute_magnitude_h": 19.56,
            "estimated_diameter": {
                "kilometers": {
                    "estimated_diameter_min": 0.300,
                    "estimated_diameter_max": 0.670
                }
            },
            "orbital_data": {
                "orbit_id": "198",
                "epoch_osculation": 2460998.5,
                "eccentricity": "0.322900253953164",
                "semi_major_axis": "1.210035237413531",
                "inclination": "2.682834335342465",
                "ascending_node_longitude": "189.3701704407356",
                "perihelion_argument": "301.7767419867221",
                "perihelion_distance": "0.8193145519604248",
                "aphelion_distance": "1.600755922866637",
                "mean_anomaly": "314.7695393000885",
                "mean_motion": "0.740469283",
                "orbit_class": {
                    "orbit_class_type": "APO"
                }
            },
            "close_approach_data": [{
                "close_approach_date": "2025-11-19",
                "close_approach_date_full": "2025-11-19T01:27:00.000Z",
                "relative_velocity": {
                    "kilometers_per_second": "9.08",
                    "kilometers_per_hour": "32689"
                },
                "miss_distance": {
                    "astronomical": "0.0379242394627406",
                    "kilometers": "5673000"
                },
                "orbiting_body": "Earth"
            }]
        };
        
        // Cargar datos
        const orpheus = simulator.loadNASAData(orpheusData);
        
        output.textContent = "=== TEST DE PROPAGACIÓN ORPHEUS ===\n\n";
        output.textContent += `Nombre: ${orpheus.name}\n`;
        output.textContent += `ID: ${orpheus.id}\n\n`;
        
        output.textContent += "Elementos Orbitales:\n";
        output.textContent += `  a = ${orpheus.elements.a.toFixed(0)} km = ${(orpheus.elements.a / simulator.AU).toFixed(6)} AU\n`;
        output.textContent += `  e = ${orpheus.elements.e.toFixed(6)}\n`;
        output.textContent += `  i = ${(orpheus.elements.i * 180 / Math.PI).toFixed(6)}°\n`;
        output.textContent += `  Ω = ${(orpheus.elements.Omega * 180 / Math.PI).toFixed(6)}°\n`;
        output.textContent += `  ω = ${(orpheus.elements.omega * 180 / Math.PI).toFixed(6)}°\n`;
        output.textContent += `  M₀ = ${(orpheus.elements.M0 * 180 / Math.PI).toFixed(6)}°\n`;
        output.textContent += `  n = ${orpheus.elements.n.toExponential(10)} rad/s\n`;
        output.textContent += `  Época = JD ${orpheus.elements.epoch}\n`;
        output.textContent += `  Período = ${(orpheus.elements.period / 86400).toFixed(2)} días\n\n`;
        
        // Fecha de acercamiento
        const approachDateStr = "2025-11-19T01:27:00.000Z";
        const approachDate = new Date(approachDateStr);
        const approachJD = simulator.dateToJulian(approachDate);
        
        output.textContent += `Fecha de acercamiento:\n`;
        output.textContent += `  Fecha ISO: ${approachDateStr}\n`;
        output.textContent += `  Date object: ${approachDate.toISOString()}\n`;
        output.textContent += `  JD calculado: ${approachJD.toFixed(6)}\n`;
        output.textContent += `  JD época: ${orpheus.elements.epoch}\n`;
        output.textContent += `  Δt = ${(approachJD - orpheus.elements.epoch).toFixed(6)} días\n\n`;
        
        // Calcular posición EN LA ÉPOCA (debería dar la distancia correcta si época = acercamiento)
        output.textContent += "=== POSICIÓN EN LA ÉPOCA ===\n";
        const posEpoch = simulator.calculatePositionAtTime(orpheus, orpheus.elements.epoch);
        output.textContent += `  Heliocéntrica: (${posEpoch.heliocentric.x.toFixed(0)}, ${posEpoch.heliocentric.y.toFixed(0)}, ${posEpoch.heliocentric.z.toFixed(0)}) km\n`;
        output.textContent += `  Radio heliocéntrico: ${(posEpoch.heliocentric.r / simulator.AU).toFixed(6)} AU\n`;
        output.textContent += `  Distancia Tierra: ${(posEpoch.earthDistance / 1e6).toFixed(3)} millones km\n\n`;
        
        // Calcular posición EN EL ACERCAMIENTO
        output.textContent += "=== POSICIÓN EN EL ACERCAMIENTO ===\n";
        const posApproach = simulator.calculatePositionAtTime(orpheus, approachJD);
        output.textContent += `  JD: ${approachJD.toFixed(6)}\n`;
        output.textContent += `  Heliocéntrica: (${posApproach.heliocentric.x.toFixed(0)}, ${posApproach.heliocentric.y.toFixed(0)}, ${posApproach.heliocentric.z.toFixed(0)}) km\n`;
        output.textContent += `  Radio heliocéntrico: ${(posApproach.heliocentric.r / simulator.AU).toFixed(6)} AU\n`;
        output.textContent += `  Distancia Tierra: ${(posApproach.earthDistance / 1e6).toFixed(3)} millones km\n`;
        output.textContent += `  ESPERADO: 5.673 millones km\n\n`;
        
        // Calcular posición 1 día ANTES
        const oneDayBeforeJD = approachJD - 1.0;
        output.textContent += "=== POSICIÓN 1 DÍA ANTES ===\n";
        const posBefore = simulator.calculatePositionAtTime(orpheus, oneDayBeforeJD);
        output.textContent += `  JD: ${oneDayBeforeJD.toFixed(6)}\n`;
        output.textContent += `  Distancia Tierra: ${(posBefore.earthDistance / 1e6).toFixed(3)} millones km\n\n`;
        
        // Diagnóstico
        const expectedDistance = 5.673; // millones km
        const actualDistance = posApproach.earthDistance / 1e6;
        const error = actualDistance - expectedDistance;
        const errorPercent = (error / expectedDistance) * 100;
        
        output.textContent += "=== DIAGNÓSTICO ===\n";
        output.textContent += `  Distancia esperada: ${expectedDistance} M km\n`;
        output.textContent += `  Distancia calculada: ${actualDistance.toFixed(3)} M km\n`;
        output.textContent += `  Error: ${error.toFixed(3)} M km (${errorPercent.toFixed(1)}%)\n`;
        
        if (Math.abs(error) < 1.0) {
            output.textContent += `  ✅ CORRECTO - Error < 1M km\n`;
        } else if (Math.abs(error) < 10.0) {
            output.textContent += `  ⚠️ ACEPTABLE - Error < 10M km (puede ser error de propagación)\n`;
        } else {
            output.textContent += `  ❌ ERROR GRAVE - Error > 10M km\n`;
            output.textContent += `  Posible causa: Bug en propagación orbital o posición de la Tierra\n`;
        }
    </script>
</body>
</html>
